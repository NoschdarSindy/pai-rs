<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Pairs</title>
    <style>
      html {
        font-size: 200%;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .field {
        text-align: center;
        cursor: pointer;
      }

    </style>
  </head>
  <body>
    <div id="root">
      <div id="settings">
        <p>Number of players: </p>
        <input id="nPlayers" type="number" min="1" max="8" step="1" value="1"/>
        <p>Field Size:</p>
        <input id="fieldSize" type="number" min="2" max="16" step="2" value="8"/>
        <button id="startBtn">Start</button>
      </div>
    </div>
    <br>
    Points: <span id="points"></span>

    <script type="module">
      import init, {
        getState,
        openField,
        closeAll,
        initGame,
        getPoints
      } from "./pkg/pairs.js";


      await init();

      let shouldAbort = false;

      function start() {
        render();
      }

      document.getElementById("startBtn").addEventListener("click", (e) => {
        e.preventDefault();
        let nPlayers = document.getElementById("nPlayers").value;
        let fieldSize = document.getElementById("fieldSize").value;
        console.log("PlayersCount: ", parseInt(nPlayers));
        console.log("FieldSize: ", parseInt(fieldSize));

        initGame(parseInt(nPlayers), parseInt(fieldSize));
        start();
      })

      function render() {
        let root = document.getElementById("root");
        root.innerHTML = "";

        let data = getState()
          .split("\n")
          .map((row) => row.trim().split(/\s+/));
        root.style.display = "inline-grid";
        root.style.gridTemplate = `repeat(${data.length}, auto) / repeat(${data[0].length}, auto)`;
        root.style.gap = `0.1rem`;

        for (let y = 0; y < data.length; y++) {
          for (let x = 0; x < data[y].length; x++) {
            let element = document.createElement("div");
            element.classList.add("field");
            element.style.fontSize = `${data.length * (-2/3) + 10}rem`;
            element.style.lineHeight = `${data.length * (-2/3) + 10}rem`;
            
            element.innerHTML = data[y][x];

            element.addEventListener("click", (evt) => {
              if (shouldAbort) {
                return;
              }

              evt.preventDefault();
              let isMismatch = openField(x, y);
              render();
              if (isMismatch) {
                shouldAbort = true;
                setTimeout(() => {
                  shouldAbort = false;
                  closeAll();
                  render();
                }, 1000);
              }
            });

            root.appendChild(element);
          }
        }

        let points = getPoints();
        let pointsContainer = document.getElementById("points");
        pointsContainer.innerHTML = points
      }
    </script>
  </body>
</html>
